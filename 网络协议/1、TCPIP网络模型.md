

[TOC]

### 一、TCP/IP网络模型

计算机与网络设备要相互通信，双方就必须基于相同的方法。比如，如何探测到通信目标、由哪一边先发起通信，使用哪种语言进行通信、怎样结束通信等规则都事先确定。

TCP/IP是互联网相关的是互联网相关的各类协议簇的总称，比如TCP，UDP，IP，FTP，HTTP，ICMP，SMTP等属于TCP/IP族内的协议。

TCP/IP模型是互联网的基础，它是一些列网络协议的总称，这些协议可以分为四层。

- **链路层**：负责封装和解封装IP报文，发送和接收ARP/RARP报文等。
- **网络层**：负责路由以及把分组报文发送给目标网络或主机
- **传输层**：负责对报文进行分组和重组，并以TCP或UDP协议格式封装报文。
- **应用层**：负责向用户提供应用程序，比如HTTP，FTP，Telnet，DNS，SMTP等。

| OSI七层模型 | TCP/IP概念层模型 | 功能                                   | TCP/IP协议簇                             |
| ----------- | ---------------- | -------------------------------------- | ---------------------------------------- |
| 应用层      |                  | 文件传输，电子邮件，文件服务，虚拟终端 | TFTP，HTTP，SNMP，FTP，SMTP，DNS，Telnet |
| 表示层      |                  | 数据格式化，代码转换，数据加密         | 没有协议                                 |
| 会话层      | 应用层           | 解除或建立与别的接点的联系             | 没有协议                                 |
| 传输层      | 传输层           | 提供对端的接口                         | TCP，UDP                                 |
| 网络层      | 网络层           | 为数据包选择路由                       | IP，TCMP，RIP，OSPF，ICMP                |
| 数据链路层  |                  | 传输有地址的帧以及错误检测功能         | SLIP，CSLIP，PPP，ARP，MTV               |
| 物理层      | 链路层           | 以二进制数据形式在物理媒体上传输数据   | ISO2110，IEEE802，IEEE802.2              |

### 二、UDP

UDP协议全称是**用户数据报协议**，在网络中它与TCP协议一样用于处理数据包，是一种无连接的协议。在OIS，在第四层——传输层，处于IP协议的上一层。UDP有不提供数据包分组，组装和不能对数据包进行排序的缺点，也就是说，当报文发送之后，是无法得知其是否安全完整到达的。

#### 1、面向无连接

首先UDP是不需要和TP一样在发送数据前进行三次握手建立连接的，想发数据就可以开始发送了。并且也只是数据报文的搬运工，不会对数据报文进行任何拆分和拼接操作。

具体就是：

- 在发送端，应用层将数据传递给传输层的UDP协议，UDP只会给数据增加一个UDP头标识下是UDP协议，然后就传输给网络层了。
- 在接收端，网络层将数据传递给传输层，UDP只去除IP报文头就传递给应用层，不回拼接操作。

#### 2、有单播、多播、广播功能

UDP不止支持一对一的传输方式，同样支持一对多，多对多，多对一的方式，也就是说UDP提供了单播，多播，广播的功能。

#### 3、UDP是面向报文的

发送方的UDP对应用程序交下来的报文，在添加首部后就向下交给IP层。UDP对应用层交下来的报文，既不合并也不拆分，而是保留这些报文的边界。因此。应用程序必须选择合适大小的报文。

#### 4、不可靠性

首先不可靠性体现在无连接上，通信都不需要建立连接。想发就发。这样的情况不可靠。

并且收到什么数据就传递什么数据，并且不会备份数据，发送数据也不回关心对方是否已经正确接收数据。

网络环境时好时坏，但是UDP没有拥塞控制，一直会以恒定的速度发送数据，即使网络条件不好，也不回对发送频率调整，这样的弊端就是在网络条件不好的情况下可能会导致丢包，但是优点也很明显，在某些实时性要求高的场景(比如电话会议)就需要使用UDP而不是TCP。

#### 5、头部开销小，传输数据报文时很高效。

- 两个十六位的端口号，分别为源端口（可选字段）和目标端口

- 整个数据报文的长度

- 整个数据报文的校验和(IPv4可选字段)，该字段用于头部信息和数据中的错误。

    因此UDP的头部开销少，只有八字节，相比TCP的至少二十字节要少得多，在传输数据报文时是很高效的。

### 三、TCP

当一台计算机想要跟另一台计算机通讯时，两台计算机之间的通信需要畅通且可靠，这样才能保证正确收发数据。例如：查看网页或电子邮件时，希望完整且顺序查看网页，下载文件时，希望获得完整的文件，而不仅仅是文件的一部分，这时就需要用到TCP。

TCP全称是**传输控制协议**，是一种面向连接的、可靠的、基于字节流的传输层通信协议，由IETF的RFC793定义，TCP是面向连接的、可靠的流协议。流就是指不间断的数据结构。

#### 1、连接过程

##### 第一次握手：

客户端向服务端发送连接请求报文段，该报文段中包含自身的数据通讯初识序号。请求发送后，客户端便进入SYN-SENT状态。

##### 第二次握手：

服务端收到连接请求报文段后，如果同意连接，则会发送一个应答，该应答中也会包含自身的数据通讯初始序号，发送完成后便进入SYN—RECEIVED状态。

##### 第三次握手：

当客户端收到连接同意后，还要向服务端发送一个确认报文。客户端发完这个报文段之后便进入ESTABLISHED状态，服务端收到这个应答后也进入ESTABLISHED状态，此时连接建立成功。

为什么TCP建立连接需要三次握手，而不是两次呢？这是因为为了防止出现时效的链接请求报文段被服务端接收的情况，从而产生错误。

#### 2、TCP断开连接

TCP是全双工的，在断开连接时两端都需要发送FIN和ACK。

##### 第一次挥手：

若客户端A认为数据发送完成，则它需要向服务端B发送连接释放请求。

##### 第二次挥手：

B收到连接释放请求后，会告诉应用层钥匙房TCP连接，然后会发送ACK包，并进入 CLOSE_WAIT 状态，此时表明 A 到 B 的连接已经释放，不再接收 A 发的数据了。但是因为 TCP 连接是双向的，所以 B 仍旧可以发送数据给 A。

##### 第三次挥手：

B如果此时有未发送完成的数据会继续发送，发送完毕后会向A发送连接释放请求，然后B便进入LAST-ACK状态。

##### 第四次挥手：

A收到释放请求后，向B发送确认应答，此时A进入TIME—WAIT状态。该状态会持续2MSL（最大段生存期，只报文段在网络中生存的时间，超时会被抛弃）时间，若该时间段没有B的重发请求的话，就会进入CLOSED状态。当B收到确认应答后，也便进入CLOSED状态。

#### 3、TCP协议的特点

- 面向连接

    面向连接，是指发送数据之前必须在两端建立连接。建立连接的方式是三次握手，这样可以建立可靠的链接。建立连接是为数据的可靠传输做基础。

- 仅支持单播传输

    每条TCP传输连接只能有两个端点，只能进行点对点的数据传输，不支持多播和广播传输方式。

- 面向字节流

    TCP不像UDP一样一个个报文独立地传输，而是在不保留报文边界的情况下以字节流方式进行传输。

- 可靠传输

    对于可靠传输，判断丢包，误码靠的是TCP的段编号以及确认号。TCP为了保证报文传输的可靠，就给每个包一个序号，同时序号也保证了传送到接收端实体的包的按序接收。然后接收端实体对已经成功收到的字节发回一个想要的确认(ACK)；如果发送端实体在合理的往返时延(RTT)内未收到确认，那么对应的数据(假设丢失了)将会被重传。

- 提供拥塞控制

    当网络出现拥塞时，TCP能够减少向网络注入数据的速率和数量，缓解拥塞。

- TCP提供全双工通信

    TCP允许通信双方的应用程序在任何时候都能发送数据，因为TCP链接的两端都设有缓存，用来临时存放双向通信的数据。当然，TCP可以发送一个数据段，也可以缓存一段时间以便一次发送更多的数据段（最大的数据段大小取决于MSS）。

### 四、TCP和UDP对比

#### 1、对比

|              | UDP                                        | TCP                                        |
| ------------ | ------------------------------------------ | ------------------------------------------ |
| 是否连接     | 无连接                                     | 面向连接                                   |
| 是否可靠     | 不可靠传输，不使用流量控制和拥塞控制       | 可靠传输，使用流量控制和拥塞控制           |
| 连接对象个数 | 支持一对一，一对多，多对一和多对多交互通信 | 只能一对一通信                             |
| 传输方式     | 面向报文                                   | 面向字节流                                 |
| 首部开销     | 首部开销小                                 | 首部最小20字节，最大60字节                 |
| 适用场景     | 适用于实时应用(IP电话、视频会议、直播等)   | 适用于要求可靠传输的应用，比如文件传输等。 |

#### 2、总结

- TCP虽然向上层提供面向连接的可靠服务，UDP向上层提供无连接不可靠服务。
- 虽然UDP并没有TCP传输来的准确，但是也能在很多实时性要求高的地方有所作为。
- 对数据准去性要求高，速度可以相对慢的，可以选用TCP。

